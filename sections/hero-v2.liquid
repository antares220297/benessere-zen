{% comment %}
  Luxe Zen Portal Hero — BenessereZen (Grok Luxe Edition)
  - Elegant, premium design without any emojis
  - Refined typography, spacious layout for lush feel
  - Multi-step gift finder with smooth fade transitions and text-only options
  - Subtle entrance animations for elements
  - Enhanced accessibility and mobile responsiveness
  - Surprise: Delicate overlay pattern for zen ambiance (CSS-generated subtle waves)
  - Tracking preserved
  - Seasonal tags with pre-select if applicable
{% endcomment %}

<section id="zen-portal-hero" class="zen-portal-hero">
  <div class="zph-bg">
    {% if section.settings.bg_video_url != blank %}
      <video class="zph-video" autoplay muted loop playsinline aria-hidden="true">
        <source src="{{ section.settings.bg_video_url | escape }}" type="video/mp4">
      </video>
    {% elsif section.settings.bg_image != blank %}
      {{ section.settings.bg_image | image_url: width: 3200 | image_tag: loading: 'lazy', alt: section.settings.bg_alt | default: '', class: 'zph-bg-image' }}
    {% endif %}
    <div class="zph-overlay" style="opacity: {{ section.settings.overlay_opacity | default: 0.4 }}"></div>
    <div class="zph-zen-pattern"></div>
  </div>

  <div class="zph-inner page-width">
    {% if section.settings.kicker != blank %}
      <div class="zph-kicker animate-entrance">{{ section.settings.kicker }}</div>
    {% endif %}

    {% if section.settings.title != blank %}
      <h1 class="zph-title animate-entrance">{{ section.settings.title }}</h1>
    {% endif %}

    {% if section.settings.subtitle != blank %}
      <p class="zph-subtitle animate-entrance">{{ section.settings.subtitle }}</p>
    {% endif %}

    <div class="zph-cta-row animate-entrance">
      {% if section.settings.primary_cta_label != blank and section.settings.primary_cta_link != blank %}
        <a href="{{ section.settings.primary_cta_link }}" class="zph-btn zph-btn--primary" data-track="primary_cta">
          {{ section.settings.primary_cta_label }}
        </a>
      {% endif %}
      {% if section.settings.quiz_cta_label != blank and section.settings.quiz_cta_link != blank %}
        <a href="{{ section.settings.quiz_cta_link }}" class="zph-btn zph-btn--secondary" data-track="quiz_cta">
          {{ section.settings.quiz_cta_label }}
        </a>
      {% endif %}
    </div>

    {%- assign portal_blocks = section.blocks | where: 'type', 'portal' -%}
    {% if portal_blocks.size > 0 %}
      <div class="zph-portals animate-entrance">
        {% for block in portal_blocks %}
          <div class="zph-portal" {{ block.shopify_attributes }} data-kind="{{ block.settings.kind | default: 'bellezza' }}">
            <a href="{{ block.settings.link | default: '#' }}" class="zph-portal-card" data-portal="{{ block.settings.kind | default: 'bellezza' }}">
              {% if block.settings.icon != blank %}
                {{ block.settings.icon | image_url: width: 160 | image_tag: loading: 'lazy', alt: block.settings.title, class: 'zph-portal-icon' }}
              {% endif %}
              <div class="zph-portal-text">
                <div class="zph-portal-kicker">{{ block.settings.kind | capitalize }}</div>
                <h2 class="zph-portal-title">{{ block.settings.title }}</h2>
                {% if block.settings.desc != blank %}
                  <p class="zph-portal-desc">{{ block.settings.desc }}</p>
                {% endif %}
              </div>
            </a>
          </div>
        {% endfor %}
      </div>
    {% endif %}

    {%- assign usp_blocks = section.blocks | where: 'type', 'usp' -%}
    {% if usp_blocks.size > 0 %}
      <ul class="zph-usps animate-entrance" role="list">
        {% for block in usp_blocks %}
          <li class="zph-usp" {{ block.shopify_attributes }}>
            {% if block.settings.icon != blank %}
              {{ block.settings.icon | image_url: width: 40 | image_tag: loading: 'lazy', alt: block.settings.text, class: 'zph-usp-icon' }}
            {% endif %}
            <span class="zph-usp-text">{{ block.settings.text }}</span>
          </li>
        {% endfor %}
      </ul>
    {% endif %}

    {%- assign tag_blocks = section.blocks | where: 'type', 'tag' -%}
    {% assign today = 'now' | date: '%Y-%m-%d' %}
    {% if tag_blocks.size > 0 %}
      <div class="zph-tags animate-entrance" role="tablist" aria-label="Seasonal Highlights">
        {% for block in tag_blocks %}
          {% assign show_from = block.settings.start_date | default: '' %}
          {% assign show_to   = block.settings.end_date | default: '' %}
          {% assign in_window = true %}
          {% if show_from != '' and today < show_from %}{% assign in_window = false %}{% endif %}
          {% if show_to != '' and today > show_to %}{% assign in_window = false %}{% endif %}

          {% if in_window %}
            {% assign target = block.settings.target | default: 'entrambe' %}
            {% assign open_finder = block.settings.open_finder %}
            <button
              class="zph-tag"
              {% if open_finder %}data-open-finder="1" data-preselect-occasione="{{ block.settings.preselect_occasione }}"{% else %}data-tag-link="{{ block.settings.link | default: '/' }}"{% endif %}
              data-target="{{ target }}"
              role="tab"
              {{ block.shopify_attributes }}>
              <span class="zph-tag-label">{{ block.settings.label }}</span>
              {% if block.settings.badge != blank %}
                <span class="zph-tag-badge">{{ block.settings.badge }}</span>
              {% endif %}
            </button>
          {% endif %}
        {% endfor %}
      </div>
    {% endif %}
  </div>

  {% if section.settings.enable_finder %}
    <div class="zph-finder" id="zph-finder" aria-hidden="true" hidden>
      <div class="zph-finder__dialog" role="dialog" aria-modal="true" aria-labelledby="zph-finder-title">
        <button class="zph-finder__close" type="button" data-finder-close aria-label="Close">×</button>
        <h2 id="zph-finder-title">Discover the Perfect Gift</h2>

        <div class="zph-finder__progress">
          <div class="zph-progress-bar">
            <div class="zph-progress-fill" style="width: 33.33%;"></div>
          </div>
        </div>

        <form class="zph-finder__form" id="zph-finder-form">
          <input type="hidden" name="b" value="">
          <input type="hidden" name="p" value="">
          <input type="hidden" name="o" value="">

          <div class="zph-steps">
            <div class="zph-step active" data-step="1">
              <label class="zph-step-label">Budget</label>
              <div class="zph-options">
                <button type="button" data-value="under-20" class="zph-option">Under 20€</button>
                <button type="button" data-value="20-40" class="zph-option">20–40€</button>
                <button type="button" data-value="40-70" class="zph-option">40–70€</button>
                <button type="button" data-value="70-plus" class="zph-option">70€+</button>
              </div>
            </div>
            <div class="zph-step" data-step="2">
              <label class="zph-step-label">For Whom</label>
              <div class="zph-options">
                <button type="button" data-value="per-lei" class="zph-option">For Her</button>
                <button type="button" data-value="per-lui" class="zph-option">For Him</button>
                <button type="button" data-value="amici" class="zph-option">For Friends</button>
                <button type="button" data-value="per-casa" class="zph-option">For the Home</button>
              </div>
            </div>
            <div class="zph-step" data-step="3">
              <label class="zph-step-label">Occasion</label>
              <div class="zph-options">
                <button type="button" data-value="compleanno" class="zph-option">Birthday</button>
                <button type="button" data-value="anniversario" class="zph-option">Anniversary</button>
                <button type="button" data-value="back-to-work" class="zph-option">Back to Work</button>
                <button type="button" data-value="pensierini" class="zph-option">Small Gestures</button>
              </div>
            </div>
          </div>

          <div class="zph-nav">
            <button type="button" class="zph-btn zph-btn--secondary zph-prev" disabled>Previous</button>
            <button type="button" class="zph-btn zph-btn--primary zph-next">Next</button>
            <button type="submit" class="zph-btn zph-btn--primary zph-submit" hidden>View Results</button>
          </div>
        </form>
      </div>
    </div>
  {% endif %}
</section>

<style>
  /* Core Styles */
  .zen-portal-hero { position: relative; color: #f5f7f4; overflow: hidden; font-family: 'Georgia', serif; /* Assuming elegant serif; adjust per theme */ }
  .zen-portal-hero .page-width { position: relative; z-index: 2; width: min(92vw, 1400px); margin: 0 auto; padding: clamp(80px, 8vw, 120px) 0 clamp(40px, 5vw, 80px); }
  .zph-bg { position: absolute; inset: 0; overflow: hidden; }
  .zph-video, .zph-bg-image { min-width: 100%; min-height: 100%; width: 100%; height: 100%; object-fit: cover; }
  .zph-overlay { position: absolute; inset: 0; background: linear-gradient(to bottom, rgba(11,26,20,0.6), rgba(11,26,20,0.3)); }
  .zph-zen-pattern { position: absolute; inset: 0; background: radial-gradient(circle, rgba(87,162,123,0.05) 0%, transparent 50%); opacity: 0.5; animation: zenWave 20s infinite ease-in-out; }

  /* Text Elements */
  .zph-kicker { display: inline-block; padding: 0.5rem 1rem; border-radius: 2rem; background: rgba(224,216,197,0.1); color: #e0d8c5; font-size: 0.9rem; letter-spacing: 0.05em; text-transform: uppercase; margin-bottom: 1.5rem; }
  .zph-title { font-size: clamp(2.5rem, 5vw, 4.5rem); line-height: 1.1; margin: 0 0 1rem; font-weight: 400; letter-spacing: -0.02em; }
  .zph-subtitle { max-width: 50ch; color: #cfd8d3; font-size: 1.1rem; line-height: 1.6; margin: 0 0 2rem; }

  /* CTAs */
  .zph-cta-row { display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 2.5rem; }
  .zph-btn { padding: 0.8rem 1.5rem; border-radius: 2rem; text-decoration: none; font-weight: 500; transition: background 0.3s, transform 0.3s; letter-spacing: 0.03em; }
  .zph-btn--primary { background: #57A27B; color: #0b1a14; }
  .zph-btn--primary:hover { background: #4a8b68; transform: translateY(-3px); }
  .zph-btn--secondary { border: 1px solid #e0d8c5; color: #e0d8c5; }
  .zph-btn--secondary:hover { background: rgba(224,216,197,0.1); transform: translateY(-3px); }

  /* Portals */
  .zph-portals { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1.5rem; max-width: 1000px; margin: 2rem auto; }
  .zph-portal-card { display: flex; align-items: center; gap: 1.5rem; padding: 1.5rem; border-radius: 1.5rem; background: rgba(255,255,255,0.04); backdrop-filter: blur(8px); color: inherit; text-decoration: none; border: 1px solid rgba(255,255,255,0.06); transition: border-color 0.3s, transform 0.3s; }
  .zph-portal-card:hover { border-color: #57A27B; transform: translateY(-5px); }
  .zph-portal-icon { width: 50px; height: 50px; object-fit: contain; }
  .zph-portal-kicker { font-size: 0.85rem; color: #a9b5ae; text-transform: uppercase; letter-spacing: 0.1em; }
  .zph-portal-title { font-size: 1.4rem; margin: 0.2rem 0 0.5rem; font-weight: 400; }
  .zph-portal-desc { color: #cfd8d3; font-size: 1rem; line-height: 1.5; }

  /* USPs */
  .zph-usps { display: flex; gap: 1rem; flex-wrap: wrap; justify-content: center; margin: 2rem 0 0; padding: 0; list-style: none; }
  .zph-usp { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem 1rem; border-radius: 2rem; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.06); font-size: 0.95rem; color: #e0d8c5; }
  .zph-usp-icon { width: 20px; height: 20px; object-fit: contain; }

  /* Tags */
  .zph-tags { display: flex; gap: 1rem; flex-wrap: wrap; justify-content: center; margin: 2.5rem 0 0; }
  .zph-tag { padding: 0.5rem 1rem; border-radius: 2rem; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.02); color: inherit; cursor: pointer; font-size: 0.95rem; transition: background 0.3s; }
  .zph-tag:hover { background: rgba(255,255,255,0.08); }
  .zph-tag-badge { margin-left: 0.5rem; font-size: 0.8rem; background: #57A27B; color: #0b1a14; border-radius: 1rem; padding: 0.2rem 0.6rem; }

  /* Animations */
  @keyframes entrance { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
  .animate-entrance { animation: entrance 1s ease-out forwards; opacity: 0; }
  .animate-entrance:nth-child(odd) { animation-delay: 0.3s; }
  .animate-entrance:nth-child(even) { animation-delay: 0.6s; }

  @keyframes zenWave { 0% { transform: scale(1); opacity: 0.5; } 50% { transform: scale(1.05); opacity: 0.3; } 100% { transform: scale(1); opacity: 0.5; } }

  /* Finder */
  .zph-finder { position: fixed; inset: 0; background: rgba(11,26,20,0.7); display: grid; place-items: center; z-index: 999; backdrop-filter: blur(5px); transition: opacity 0.4s; }
  .zph-finder[aria-hidden="false"] { opacity: 1; }
  .zph-finder[aria-hidden="true"] { opacity: 0; pointer-events: none; }
  .zph-finder__dialog { background: #0f1f19; color: #f5f7f4; width: min(92vw, 600px); border-radius: 1.5rem; padding: 2rem; border: 1px solid rgba(255,255,255,0.08); box-shadow: 0 20px 40px rgba(0,0,0,0.4); animation: entrance 0.5s ease-out; }
  .zph-finder__close { position: absolute; top: 1rem; right: 1rem; background: transparent; border: none; color: #cfd8d3; font-size: 1.8rem; cursor: pointer; transition: color 0.3s; }
  .zph-finder__close:hover { color: #fff; }
  .zph-finder__progress { margin: 1.5rem 0; }
  .zph-progress-bar { height: 4px; background: #2a3b34; border-radius: 2px; overflow: hidden; }
  .zph-progress-fill { height: 100%; background: #57A27B; transition: width 0.4s ease; }
  .zph-steps { position: relative; height: 200px; }
  .zph-step { position: absolute; top: 0; left: 0; width: 100%; opacity: 0; transition: opacity 0.4s ease; text-align: center; }
  .zph-step.active { opacity: 1; }
  .zph-step-label { display: block; font-size: 1.2rem; margin-bottom: 1.5rem; color: #e0d8c5; text-transform: uppercase; letter-spacing: 0.05em; }
  .zph-options { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; }
  .zph-option { padding: 1rem; border-radius: 1rem; border: 1px solid #2a3b34; background: #0b1a14; color: #f5f7f4; cursor: pointer; font-size: 1rem; transition: border-color 0.3s, background 0.3s; text-align: center; }
  .zph-option:hover, .zph-option.selected { border-color: #57A27B; background: rgba(87,162,123,0.08); }
  .zph-nav { display: flex; justify-content: space-between; margin-top: 2rem; }

  @media (max-width: 740px) {
    .zph-portals { grid-template-columns: 1fr; }
    .zph-options { grid-template-columns: 1fr; }
    .zph-usps, .zph-tags { justify-content: flex-start; }
  }
</style>

<script>
  (function(){
    const root = document.getElementById('zen-portal-hero');
    if(!root) return;

    const finder = document.getElementById('zph-finder');
    if(finder){
      finder.hidden = true;
      finder.setAttribute('aria-hidden','true');
    }

    window.dataLayer = window.dataLayer || [];
    function track(ev, payload){ try{ window.dataLayer.push(Object.assign({event:ev}, payload||{})); }catch(e){} }

    root.querySelectorAll('[data-track="primary_cta"]').forEach(el => {
      el.addEventListener('click', () => track('portal_primary_cta'));
    });
    root.querySelectorAll('[data-track="quiz_cta"]').forEach(el => {
      el.addEventListener('click', () => track('quiz_cta_click'));
    });

    root.querySelectorAll('.zph-portal-card').forEach(el => {
      el.addEventListener('click', () => {
        track('portal_click', { portal: el.dataset.portal || 'unknown' });
      });
    });

    root.querySelectorAll('.zph-tag').forEach(tag => {
      const link = tag.getAttribute('data-tag-link');
      const opensFinder = tag.hasAttribute('data-open-finder');
      const preselectOccasione = tag.getAttribute('data-preselect-occasione');
      tag.addEventListener('click', () => {
        if(opensFinder) {
          openFinder(preselectOccasione);
          track('gf_open');
        } else if(link) {
          window.location.href = link;
        }
      });
    });

    let currentStep = 1;
    const totalSteps = 3;
    const steps = finder ? finder.querySelectorAll('.zph-step') : [];
    const progressFill = finder ? finder.querySelector('.zph-progress-fill') : null;
    const prevBtn = finder ? finder.querySelector('.zph-prev') : null;
    const nextBtn = finder ? finder.querySelector('.zph-next') : null;
    const submitBtn = finder ? finder.querySelector('.zph-submit') : null;
    const form = finder ? finder.querySelector('#zph-finder-form') : null;

    function updateStep() {
      steps.forEach((step, idx) => step.classList.toggle('active', idx + 1 === currentStep));
      progressFill.style.width = `${(currentStep / totalSteps) * 100}%`;
      prevBtn.disabled = currentStep === 1;
      nextBtn.hidden = currentStep === totalSteps;
      submitBtn.hidden = currentStep !== totalSteps;
    }

    function selectOption(step, value) {
      const inputName = ['b', 'p', 'o'][step - 1];
      form.elements[inputName].value = value;
      const options = steps[step - 1].querySelectorAll('.zph-option');
      options.forEach(opt => opt.classList.toggle('selected', opt.dataset.value === value));
    }

    if (finder) {
      finder.querySelectorAll('.zph-option').forEach(opt => {
        opt.addEventListener('click', () => {
          const step = parseInt(opt.closest('.zph-step').dataset.step);
          selectOption(step, opt.dataset.value);
          if (currentStep < totalSteps) {
            currentStep++;
            updateStep();
          }
        });
      });

      prevBtn.addEventListener('click', () => {
        if (currentStep > 1) {
          currentStep--;
          updateStep();
        }
      });

      nextBtn.addEventListener('click', () => {
        if (currentStep < totalSteps) {
          currentStep++;
          updateStep();
        }
      });

      form.addEventListener('submit', e => {
        e.preventDefault();
        const b = form.elements['b'].value;
        const p = form.elements['p'].value;
        const o = form.elements['o'].value;
        if (!b || !p || !o) return;
        track('gf_submit', { budget: b, persona: p, occasione: o });
        const base = "{{ section.settings.gifts_collection | default: '/collections/oggettistica-e-idee-regalo' }}";
        window.location.href = `${base}?gf=1&b=${encodeURIComponent(b)}&p=${encodeURIComponent(p)}&o=${encodeURIComponent(o)}`;
      });
    }

    function openFinder(preselect = null) {
      if (!finder) return;
      currentStep = 1;
      updateStep();
      ['b', 'p', 'o'].forEach(name => form.elements[name].value = '');
      form.querySelectorAll('.zph-option').forEach(opt => opt.classList.remove('selected'));
      if (preselect) {
        selectOption(3, preselect);
        currentStep = 3;
        updateStep();
      }
      finder.hidden = false;
      finder.setAttribute('aria-hidden', 'false');
      const closeBtn = finder.querySelector('[data-finder-close]');
      if (closeBtn) closeBtn.focus();
    }

    function closeFinder() {
      if (!finder) return;
      finder.hidden = true;
      finder.setAttribute('aria-hidden', 'true');
    }

    if (finder) {
      finder.addEventListener('click', e => { if (e.target === finder) closeFinder(); });
      finder.querySelectorAll('[data-finder-close]').forEach(btn => btn.addEventListener('click', closeFinder));
      document.addEventListener('keydown', e => { if (!finder.hidden && e.key === 'Escape') closeFinder(); });
    }
  })();
</script>

{% schema %}
{
  "name": "Luxe Zen Portal Hero",
  "tag": "section",
  "class": "section",
  "settings": [
    { "type": "image_picker", "id": "bg_image", "label": "Background Image" },
    { "type": "url", "id": "bg_video_url", "label": "Background MP4 Video (optional)" },
    { "type": "text", "id": "bg_alt", "label": "Image Alt Text (SEO)" },
    { "type": "range", "id": "overlay_opacity", "label": "Overlay Intensity", "min": 0, "max": 0.8, "step": 0.1, "default": 0.4 },

    { "type": "text", "id": "kicker", "label": "Kicker Text" },
    { "type": "text", "id": "title", "label": "Title" },
    { "type": "textarea", "id": "subtitle", "label": "Subtitle" },

    { "type": "text", "id": "primary_cta_label", "label": "Primary CTA – Text", "default": "Explore Collections" },
    { "type": "url",  "id": "primary_cta_link",  "label": "Primary CTA – Link" },

    { "type": "text", "id": "quiz_cta_label", "label": "Quiz CTA – Text" },
    { "type": "url",  "id": "quiz_cta_link",  "label": "Quiz CTA – Link" },

    { "type": "checkbox", "id": "enable_finder", "label": "Enable Gift Finder", "default": true },
    { "type": "url", "id": "gifts_collection", "label": "Gifts Collection (fallback if empty)" },
    { "type": "paragraph", "content": "If empty: /collections/oggettistica-e-idee-regalo" }
  ],
  "blocks": [
    {
      "type": "portal",
      "name": "Portal",
      "settings": [
        { "type": "select", "id": "kind", "label": "Type", "options": [
          { "value": "bellezza", "label": "Beauty" },
          { "value": "oggettistica", "label": "Objects & Gifts" }
        ], "default": "bellezza" },
        { "type": "text", "id": "title", "label": "Title", "default": "Beauty" },
        { "type": "text", "id": "desc", "label": "Description" },
        { "type": "image_picker", "id": "icon", "label": "Icon (optional, premium SVG recommended)" },
        { "type": "url", "id": "link", "label": "Link" }
      ]
    },
    {
      "type": "usp",
      "name": "USP / Highlight",
      "limit": 5,
      "settings": [
        { "type": "image_picker", "id": "icon", "label": "Icon (optional, subtle premium icon)" },
        { "type": "text", "id": "text", "label": "Text", "default": "Pure Formulas" }
      ]
    },
    {
      "type": "tag",
      "name": "Seasonal Highlight",
      "settings": [
        { "type": "text", "id": "label", "label": "Label", "default": "Gift Ideas" },
        { "type": "text", "id": "badge", "label": "Badge (optional)" },
        { "type": "url",  "id": "link",  "label": "Link (if not opening finder)" },
        { "type": "select", "id": "target", "label": "Target", "options": [
          { "value": "bellezza", "label": "Beauty" },
          { "value": "oggettistica", "label": "Objects" },
          { "value": "entrambe", "label": "Both" }
        ], "default": "entrambe" },
        { "type": "checkbox", "id": "open_finder", "label": "Open Gift Finder on Click", "default": true },
        { "type": "text", "id": "preselect_occasione", "label": "Pre-select Occasion (e.g., compleanno)" },
        { "type": "text", "id": "start_date", "label": "Show From (YYYY-MM-DD)" },
        { "type": "text", "id": "end_date", "label": "Show Until (YYYY-MM-DD)" }
      ]
    }
  ],
  "max_blocks": 12,
  "presets": [
    {
      "name": "Luxe Zen Portal Hero",
      "blocks": [
        { "type": "portal", "settings": { "kind": "bellezza", "title": "Beauty" } },
        { "type": "portal", "settings": { "kind": "oggettistica", "title": "Objects & Gifts" } },
        { "type": "usp", "settings": { "text": "Pure Formulas" } },
        { "type": "usp", "settings": { "text": "Secure Shipping" } },
        { "type": "usp", "settings": { "text": "4.9/5 Reviews" } }
      ]
    }
  ]
}
{% endschema %}