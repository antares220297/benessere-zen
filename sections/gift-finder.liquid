{% comment %}
  GIFT‑FINDER MODAL — Sezione indipendente
  - Pulsante apri‑modal + Modal con form (budget, persona, occasione)
  - Submit → redirect alla collection con query string ?gf=1&b=&p=&o=
  - Tutto editabile dal Theme Editor
{% endcomment %}

{% assign _sid2 = section.id %}
<section id="gift-finder-{{ _sid2 }}" class="gift-finder" data-gf-root>
  {% if section.settings.show_button %}
    <button class="gf-open btn" type="button" aria-haspopup="dialog" aria-controls="gf-modal-{{ _sid2 }}">{{ section.settings.button_label }}</button>
  {% endif %}

  <div class="gf-modal" id="gf-modal-{{ _sid2 }}" role="dialog" aria-modal="true" aria-labelledby="gf-title-{{ _sid2 }}" hidden>
    <div class="gf-backdrop" data-gf-close tabindex="-1" aria-hidden="true"></div>
    <div class="gf-dialog" role="document">
      <button class="gf-close" type="button" aria-label="Chiudi" data-gf-close>×</button>
      <h2 id="gf-title-{{ _sid2 }}" class="gf-title">{{ section.settings.title }}</h2>
      {% if section.settings.subtitle != blank %}<p class="gf-sub">{{ section.settings.subtitle }}</p>{% endif %}

      <form class="gf-form" data-gf-form>
        <div class="gf-field">
          <label for="gf-b-{{ _sid2 }}">Budget</label>
          <select id="gf-b-{{ _sid2 }}" name="b" required>
            {%- assign _raw_b = section.settings.budget_options | default: '' -%}
            {%- if _raw_b != '' -%}
              {%- assign _opts_b = _raw_b | split: ',' -%}
              {%- for o in _opts_b -%}
                {%- assign opt = o | strip -%}
                <option value="{{ opt | url_encode }}">{{ opt }}</option>
              {%- endfor -%}
            {%- endif -%}
          </select>
        </div>

        <div class="gf-field">
          <label for="gf-p-{{ _sid2 }}">Per chi</label>
          <select id="gf-p-{{ _sid2 }}" name="p" required>
            {%- assign _raw_p = section.settings.persona_options | default: '' -%}
            {%- if _raw_p != '' -%}
              {%- assign _opts_p = _raw_p | split: ',' -%}
              {%- for o in _opts_p -%}
                {%- assign opt = o | strip -%}
                <option value="{{ opt | url_encode }}">{{ opt }}</option>
              {%- endfor -%}
            {%- endif -%}
          </select>
        </div>

        <div class="gf-field">
          <label for="gf-o-{{ _sid2 }}">Occasione</label>
          <select id="gf-o-{{ _sid2 }}" name="o" required>
            {%- assign _raw_o = section.settings.occasion_options | default: '' -%}
            {%- if _raw_o != '' -%}
              {%- assign _opts_o = _raw_o | split: ',' -%}
              {%- for o in _opts_o -%}
                {%- assign opt = o | strip -%}
                <option value="{{ opt | url_encode }}">{{ opt }}</option>
              {%- endfor -%}
            {%- endif -%}
          </select>
        </div>

        <button class="btn btn-primary" type="submit">{{ section.settings.submit_label }}</button>
      </form>
    </div>
  </div>
</section>

<style>
  #gift-finder-{{ _sid2 }} { --gf-accent: {{ section.settings.accent_color }}; }
  #gift-finder-{{ _sid2 }} .btn { display:inline-flex; align-items:center; justify-content:center; padding:12px 18px; border-radius:999px; border:1px solid transparent; background: var(--gf-accent); color:#fff; font-weight:600; }

  #gift-finder-{{ _sid2 }} .gf-modal[hidden] { display:none; }
  #gift-finder-{{ _sid2 }} .gf-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.5); }
  #gift-finder-{{ _sid2 }} .gf-dialog { position:fixed; inset:auto 0 0 0; margin:auto; max-width:560px; background:#fff; color:#111; border-radius:16px 16px 0 0; padding:20px; box-shadow:0 -10px 40px rgba(0,0,0,.25); }
  @media(min-width:720px){ #gift-finder-{{ _sid2 }} .gf-dialog{ inset:0; height:max-content; border-radius:18px; max-height:80vh; overflow:auto; padding:26px; } }
  #gift-finder-{{ _sid2 }} .gf-close { position:absolute; right:10px; top:10px; background:transparent; border:0; font-size:26px; line-height:1; cursor:pointer; }
  #gift-finder-{{ _sid2 }} .gf-title { font-size: clamp(22px, 4vw, 30px); margin: 0 0 6px; }
  #gift-finder-{{ _sid2 }} .gf-sub { margin: 0 0 14px; opacity:.8; }
  #gift-finder-{{ _sid2 }} .gf-form { display:grid; gap:12px; }
  #gift-finder-{{ _sid2 }} .gf-field { display:grid; gap:6px; }
  #gift-finder-{{ _sid2 }} label { font-weight:600; }
  #gift-finder-{{ _sid2 }} select { appearance:none; width:100%; border-radius:12px; border:1px solid #e5e5e5; padding:10px 12px; background:#fff; }
</style>

<script>
  (function(){
    const root = document.querySelector('#gift-finder-{{ _sid2 }}');
    if(!root) return;
    const modal = root.querySelector('.gf-modal');
    const openBtn = root.querySelector('.gf-open');
    const closeEls = root.querySelectorAll('[data-gf-close]');
    const form = root.querySelector('[data-gf-form]');

    function open(){ modal.hidden = false; document.body.style.overflow = 'hidden'; requestAnimationFrame(()=> root.querySelector('.gf-close')?.focus()); }
    function close(){ modal.hidden = true; document.body.style.overflow = ''; }

    openBtn?.addEventListener('click', open);
    closeEls.forEach(el=> el.addEventListener('click', close));
    modal?.addEventListener('keydown', (e)=> { if(e.key === 'Escape') close(); });

    form?.addEventListener('submit', function(e){
      e.preventDefault();
      const params = new URLSearchParams(new FormData(form));
      params.set('gf','1');
      const base = "{{ routes.collections_url }}/{{ section.settings.dest_collection | default: 'oggettistica-idee-regalo' }}";
      window.location.href = base + '?' + params.toString();
    });
  })();
</script>

{% schema %}
{
  "name": "Gift‑Finder Modal",
  "tag": "section",
  "class": "section gift-finder-section",
  "settings": [
    { "type":"checkbox", "id":"show_button", "label":"Mostra pulsante apri‑modal", "default": true },
    { "type":"text", "id":"button_label", "label":"Etichetta pulsante", "default":"Trova il regalo perfetto" },
    { "type":"text", "id":"title", "label":"Titolo modal", "default":"Trova il regalo perfetto" },
    { "type":"textarea", "id":"subtitle", "label":"Sottotitolo", "default":"Filtra in base a budget, persona e occasione." },
    { "type":"text", "id":"dest_collection", "label":"Handle collection destinazione", "default":"oggettistica-idee-regalo", "info":"Esempio: oggettistica-idee-regalo" },

    { "type":"text", "id":"budget_options", "label":"Opzioni Budget (separate da virgola)", "default":"Sotto €20, €20–€30, €30–€50, Oltre €50" },
    { "type":"text", "id":"persona_options", "label":"Opzioni Persona (separate da virgola)", "default":"Lei, Lui, Amica, Mamma, Papà" },
    { "type":"text", "id":"occasion_options", "label":"Opzioni Occasione (separate da virgola)", "default":"Compleanno, Anniversario, Natale, Ringraziamento, Laurea" },

    { "type":"text", "id":"submit_label", "label":"Etichetta bottone invio", "default":"Vedi i risultati" },
    { "type":"color", "id":"accent_color", "label":"Colore accento (bottoni)", "default":"#2c7a7b" }
  ],
  "presets": [
    { "name":"Home – Gift‑Finder Modal", "category":"Popups" }
  ]
}
{% endschema %}